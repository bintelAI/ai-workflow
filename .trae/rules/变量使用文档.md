# 工作流变量使用文档

## 1. 变量概述

工作流系统中的变量用于在不同节点之间传递数据，实现节点间的数据共享和交互。变量可以来自全局参数、上游节点输出、系统内置变量或循环上下文。

## 2. 变量类型

### 2.1 全局参数（Global Variables）

全局参数来自开始节点（Start Node）的输入数据，通过 JSON 格式配置，可在整个流程中使用。

**默认示例**：

```json
{
  "order_id": "ORD-2024-001",
  "amount": 8500,
  "currency": "CNY",
  "requester": {
    "id": "U-8821",
    "name": "Alex Chen",
    "department": "Engineering"
  },
  "items": [
    { "name": "Server License", "price": 4000 },
    { "name": "Cloud Credits", "price": 4500 }
  ]
}
```

**访问方式**：

- `{{payload.order_id}}` - 订单 ID
- `{{payload.amount}}` - 金额
- `{{payload.currency}}` - 货币
- `{{payload.requester.name}}` - 请求者姓名
- `{{payload.items}}` - 商品列表
- `{{payload.items.0.name}}` - 第一个商品名称

**配置位置**：在开始节点的配置面板中，通过"开发模式输入"字段设置。

---

### 2.2 上游节点输出（Upstream Node Outputs）

每个节点执行后会产生输出数据，下游节点可以访问这些数据。系统会自动追踪上游节点并提取其输出。

**访问方式**：

- `{{nodes.<node_id>.output_field}}`

**各节点类型的标准输出**：

| 节点类型 | 输出字段 | 类型 | 说明 |
|---------|---------|------|------|
| **API 调用** | `nodes.<id>.data` | object | 响应体 |
| | `nodes.<id>.status` | number | HTTP 状态码 |
| | `nodes.<id>.headers` | object | 响应头 |
| **LLM 模型** | `nodes.<id>.text` | string | AI 回复文本 |
| | `nodes.<id>.response` | object | 完整响应对象 |
| **SQL 节点** | `nodes.<id>.data` | array | 查询结果数组 |
| | `nodes.<id>.affectedRows` | number | 受影响行数 |
| | `nodes.<id>.output` | object | 完整执行结果 |
| **脚本代码** | `nodes.<id>.output` | object | 脚本返回值 |
| **数据操作** | `nodes.<id>.result` | object | 处理结果 |
| **条件节点** | `nodes.<id>.result` | boolean | 判断结果 |
| **循环节点** | `nodes.<id>.result` | array | 聚合结果 |
| **知识库检索** | `nodes.<id>.result` | string | 检索结果 |
| | `nodes.<id>.context` | string | 上下文 |
| | `nodes.<id>.references` | array | 引用列表 |
| **文档提取器** | `nodes.<id>.text` | string | 提取的文本 |

**使用示例**：

```
# 在 API 调用节点中使用上游节点的输出
URL: https://api.example.com/orders/{{payload.order_id}}

# 在 LLM 节点中使用 API 调用的结果
提示词: 请分析以下数据：{{nodes.api_call_123.data}}

# 在条件节点中使用多个上游节点的输出
条件: {{nodes.api_call_123.status}} == 200 && {{nodes.data_op_456.result.success}}
```

---

### 2.3 系统变量（System Variables）

系统内置的变量，提供流程执行过程中的上下文信息。

| 变量名 | 描述 | 类型 | 示例值 |
|--------|------|------|--------|
| `{{system.timestamp}}` | 当前时间戳（ISO 格式） | date | 2024-01-15T10:30:00.000Z |
| `{{system.workflow_id}}` | 工作流 ID | string | wf-abc123 |
| `{{system.execution_id}}` | 执行 ID | string | exec-xyz789 |

**使用场景**：

```
# 在通知节点中使用时间戳
消息: 订单处理完成，时间：{{system.timestamp}}

# 在日志节点中使用执行 ID
日志: 执行 ID - {{system.execution_id}}
```

---

### 2.4 循环内部变量（Loop Context Variables）

在循环节点内部或循环节点的子节点中，可以访问循环相关的变量。

| 变量名 | 描述 | 类型 | 示例值 |
|--------|------|------|--------|
| `{{loop.item}}` | 当前循环项 | any | 当前迭代的数组元素 |
| `{{loop.index}}` | 当前循环索引（从 0 开始） | number | 0, 1, 2, ... |

**使用场景**：

```
# 在循环节点的子节点中访问当前项
API URL: https://api.example.com/items/{{loop.item.id}}

# 在 LLM 节点中处理当前项
提示词: 请分析第 {{loop.index}} 项：{{loop.item.name}}

# 在数据操作节点中标记索引
操作: 为第 {{loop.index}} 项添加标记
```

**循环模式**：

1. **顺序模式（Loop）**：按顺序逐个处理数组元素
2. **并发模式（Iteration）**：并发处理数组元素（可设置并发数）

---

## 3. 变量使用语法

### 3.1 变量占位符格式

系统支持双大括号格式：

```
{{ variable.path }}
```

**示例**：

```
# 在字符串中使用变量
"订单ID：{{payload.order_id}}"
"金额：{{payload.amount}} {{payload.currency}}"

# 在对象中使用变量
{
  "url": "https://api.example.com/orders/{{payload.order_id}}",
  "method": "GET"
}

# 在 SQL 语句中使用变量
SELECT * FROM orders WHERE id = '{{payload.order_id}}'
```

---

### 3.2 变量选择器组件

在配置面板中，可以使用变量选择器组件方便地选择和插入变量：

#### **VariableSelector（单变量选择）**

适用于需要选择单个变量的场景（如下拉框样式）。

**使用方式**：
1. 点击变量输入框
2. 从弹出的变量绑定弹窗中选择所需变量
3. 系统会自动插入变量占位符

**适用场景**：
- API 调用的 URL 参数
- SQL 节点的数据库 ID
- 条件节点的变量字段

#### **VariableInput（混合文本与变量）**

适用于需要混合输入文本和变量的场景（如 API URL、提示词）。

**使用方式**：
1. 在输入框中直接输入文本
2. 点击右侧的变量图标（{}）打开变量选择器
3. 选择变量后，变量会插入到光标位置

**适用场景**：
- API 调用的完整 URL
- LLM 节点的提示词
- 通知节点的消息内容

#### **VariableTextArea（多行文本与变量）**

适用于需要多行文本和变量混合的场景（如脚本代码、SQL 语句）。

**使用方式**：
1. 在文本框中输入多行文本
2. 点击右侧的变量图标打开变量选择器
3. 选择变量后，变量会插入到光标位置

**适用场景**：
- SQL 节点的 SQL 语句
- 脚本节点的代码
- 复杂的提示词模板

---

### 3.3 SQL 特殊语法

SQL 节点支持特殊的模板语法，可以在 SQL 语句中使用条件判断和变量替换。

#### **IF 逻辑**

```
{% if condition %}
  SQL 语句（条件为真时执行）
{% else %}
  SQL 语句（条件为假时执行）
{% endif %}
```

#### **变量替换**

```
{{variable}}
```

#### **完整示例**

```sql
SELECT * FROM orders
WHERE status = '{{payload.status}}'
{% if payload.min_amount %}
  AND amount >= {{payload.min_amount}}
{% endif %}
{% if payload.max_amount %}
  AND amount <= {{payload.max_amount}}
{% endif %}
ORDER BY created_at DESC
```

**支持的运算符**：
- `==` 等于
- `!=` 不等于
- `>` 大于
- `<` 小于
- `>=` 大于等于
- `<=` 小于等于
- `contains` 包含
- `not_contains` 不包含
- `empty` 为空
- `not_empty` 不为空

---

## 4. 变量作用域

### 4.1 变量选择器的作用域（Scope）

变量选择器支持三种作用域：

| 作用域 | 说明 | 适用场景 |
|--------|------|---------|
| `upstream` | 仅显示上游节点（默认） | 大多数节点配置 |
| `internal` | 仅显示当前节点的子节点 | 循环节点的输出配置 |
| `all` | 显示所有节点 | 特殊场景 |

**使用示例**：

```tsx
// 默认作用域（upstream）
<VariableSelector value={value} onChange={onChange} />

// 循环节点的输出配置（internal）
<VariableSelector value={value} onChange={onChange} scope="internal" />

// 显示所有节点
<VariableSelector value={value} onChange={onChange} scope="all" />
```

---

### 4.2 变量优先级

当多个变量来源存在同名变量时，优先级如下（从高到低）：

1. **循环上下文**（loop）- 仅在循环节点内部
2. **上游节点输出**（nodes）
3. **全局参数**（payload）
4. **系统变量**（system）

---

## 5. 不同节点类型的变量使用

### 5.1 API 调用节点

**请求 URL**：

```
https://api.example.com/orders/{{payload.order_id}}
```

**请求体**：

```json
{
  "amount": {{payload.amount}},
  "currency": "{{payload.currency}}",
  "requester": "{{payload.requester.name}}",
  "items": {{payload.items}}
}
```

**查询参数**：

```
?status={{payload.status}}&limit={{payload.limit}}
```

**请求头**：

```
Authorization: Bearer {{payload.token}}
```

---

### 5.2 LLM 节点

**提示词模板**：

```
请分析以下订单信息：

订单号：{{payload.order_id}}
金额：{{payload.amount}} {{payload.currency}}
请求者：{{payload.requester.name}}

API 返回的数据：
{{nodes.api_call_123.data}}

请提供详细的分析报告。
```

**系统提示词**：

```
你是一个专业的订单分析助手。当前时间是 {{system.timestamp}}。
```

---

### 5.3 SQL 节点

**基础查询**：

```sql
SELECT * FROM orders
WHERE id = '{{payload.order_id}}'
```

**条件查询**：

```sql
SELECT * FROM orders
WHERE status = '{{payload.status}}'
{% if payload.min_amount %}
  AND amount >= {{payload.min_amount}}
{% endif %}
{% if payload.max_amount %}
  AND amount <= {{payload.max_amount}}
{% endif %}
```

**使用上游节点数据**：

```sql
INSERT INTO order_logs (order_id, status, created_at)
VALUES ('{{nodes.api_call_123.data.id}}', '{{nodes.api_call_123.data.status}}', '{{system.timestamp}}')
```

---

### 5.4 条件节点

**简单条件**：

```
{{payload.amount}} > 10000
```

**复合条件**：

```
{{payload.amount}} > 10000 && {{payload.currency}} == 'CNY'
```

**使用上游节点输出**：

```
{{nodes.api_call_123.status}} == 200
```

**使用循环变量**：

```
{{loop.item.status}} == 'active'
```

---

### 5.5 通知节点

**邮件内容**：

```
尊敬的{{payload.requester.name}}，

您的订单{{payload.order_id}}已处理完成。

订单详情：
- 金额：{{payload.amount}} {{payload.currency}}
- 状态：{{nodes.api_call_123.data.status}}
- 处理时间：{{system.timestamp}}

如有疑问，请联系客服。

此致，
订单系统
```

---

### 5.6 脚本节点

**JavaScript 代码**：

```javascript
// 访问全局变量
const orderId = context.payload.order_id
const amount = context.payload.amount

// 访问上游节点输出
const apiResponse = context.nodes.api_call_123.response

// 访问循环变量
const currentItem = context.loop.item
const currentIndex = context.loop.index

// 处理数据
const result = {
  orderId: orderId,
  amount: amount,
  status: apiResponse.status === 200 ? 'success' : 'failed',
  processedAt: context.system.timestamp,
  loopIndex: currentIndex
}

// 返回结果
return result
```

---

### 5.7 循环节点

**目标数组**：

```
{{payload.items}}
```

**子节点中使用循环变量**：

```
API URL: https://api.example.com/items/{{loop.item.id}}
```

**终止条件**：

```
{{loop.item.status}} == 'completed'
```

**导出输出变量**：

```
nodes.llm_123.text
```

---

## 6. 变量替换机制

系统在节点执行前会自动替换配置中的变量占位符，替换过程如下：

### 6.1 替换流程

1. **收集上下文**：收集当前上下文所有可用变量（全局参数、上游节点输出、系统变量、循环变量）
2. **递归遍历**：递归遍历节点配置对象
3. **替换占位符**：替换所有字符串值中的变量占位符
4. **执行节点**：使用替换后的值执行节点

### 6.2 替换函数

**replaceVariables** - 简单字符串替换

```typescript
function replaceVariables(str: string, variables: any): string {
  return str.replace(/\{\{(.*?)\}\}/g, (match, variableName) => {
    const value = getVariableValue(variables, variableName.trim())
    return value !== undefined ? String(value) : match
  })
}
```

**getVariableValue** - 深层获取变量值

```typescript
function getVariableValue(obj: any, path: string): any {
  const cleanPath = path.replace(/\{\{(.*?)\}\}/g, '$1').trim()
  const parts = cleanPath.split('.')
  let current = obj
  for (const part of parts) {
    if (current === undefined || current === null) return undefined
    current = current[part]
  }
  return current
}
```

---

## 7. 最佳实践

### 7.1 命名规范

- **节点命名**：使用清晰、描述性的名称，如"获取订单信息"、"发送邮件通知"
- **变量命名**：使用有意义的字段名，如 `order_id` 而非 `id`
- **路径清晰**：避免过深的嵌套，提高可读性

### 7.2 类型检查

- 在使用变量前，了解其类型（string、number、boolean、object、array）
- 在条件判断中，注意类型转换
- 在 SQL 查询中，字符串值需要加引号

### 7.3 错误处理

- 为可能为空的变量提供默认值
- 使用条件判断避免访问不存在的属性
- 在模拟运行时检查变量替换结果

### 7.4 性能优化

- 在循环节点中，避免在每次迭代中重复计算
- 合理使用并发模式提高处理效率
- 避免在循环中调用耗时操作

### 7.5 文档化

- 为复杂的工作流添加注释说明
- 记录主要变量的来源和用途
- 使用节点描述字段说明节点功能

---

## 8. 变量使用示例

### 8.1 简单流程示例

**流程**：开始 → API 调用 → 条件判断 → 通知

**开始节点配置**：
```json
{
  "order_id": "ORD-2024-001",
  "amount": 8500,
  "currency": "CNY",
  "requester": {
    "name": "Alex Chen",
    "email": "alex@example.com"
  }
}
```

**API 调用节点**：
- URL: `https://api.example.com/orders/{{payload.order_id}}`
- 方法: GET

**条件节点**：
- 条件: `{{nodes.api_call_123.status}} == 200`

**通知节点**：
- 收件人: `{{payload.requester.email}}`
- 内容: `订单{{payload.order_id}}处理完成`

---

### 8.2 复杂流程示例

**流程**：开始 → 数据操作 → API 调用 → 条件判断 → 循环 → LLM → 通知

**开始节点配置**：
```json
{
  "user_id": "U-8821",
  "query": "分析最近的订单趋势",
  "date_range": {
    "start": "2024-01-01",
    "end": "2024-01-31"
  }
}
```

**数据操作节点**：
- 操作: 过滤订单数据
- 输出: `filtered_orders`

**API 调用节点**：
- URL: `https://api.example.com/orders`
- 查询参数: `?start={{payload.date_range.start}}&end={{payload.date_range.end}}`
- 输出: `api_orders`

**条件节点**：
- 条件: `{{nodes.api_call_123.status}} == 200 && {{nodes.data_op_456.result.count}} > 0`

**循环节点**：
- 目标数组: `{{nodes.api_call_123.data.items}}`
- 模式: 并发（并发数 10）

**LLM 节点（循环内）**：
- 提示词: `分析第{{loop.index}}个订单：{{loop.item}}`

**通知节点**：
- 内容: `分析完成，共处理{{nodes.loop_123.result.length}}个订单`

---

## 9. 故障排除

### 9.1 变量替换失败

**症状**：变量未被替换，显示为 `{{variable.path}}`

**可能原因**：
- 变量路径拼写错误
- 上游节点未正确执行
- 变量不在当前作用域内

**解决方案**：
- 检查变量路径是否正确
- 确保上游节点已成功执行
- 使用数据抽屉查看实际变量值

---

### 9.2 变量值为空

**症状**：变量被替换为 `undefined` 或空字符串

**可能原因**：
- 全局参数未配置
- 上游节点未返回预期输出
- 变量路径不存在

**解决方案**：
- 检查开始节点的开发模式输入
- 查看上游节点的执行日志
- 使用数据抽屉验证变量值

---

### 9.3 类型错误

**症状**：条件判断失败或 SQL 查询错误

**可能原因**：
- 变量类型与预期不符
- 字符串值未加引号
- 数值被当作字符串处理

**解决方案**：
- 在条件判断中使用类型转换
- SQL 中的字符串值加引号
- 使用数据操作节点进行类型转换

---

### 9.4 循环变量无法访问

**症状**：在循环节点的子节点中无法访问 `loop.item` 或 `loop.index`

**可能原因**：
- 节点不在循环节点的子节点中
- 循环目标不是数组
- 循环未正确执行

**解决方案**：
- 确保节点是循环节点的子节点
- 检查循环目标是否为数组
- 查看循环节点的执行日志

---

## 10. 调试工具

### 10.1 数据抽屉（Data Drawer）

通过数据抽屉可以查看流程执行过程中的变量值，帮助调试和验证变量使用是否正确。

**功能**：
- 查看全局参数（payload）
- 查看各节点的输出数据
- 查看系统变量
- 查看循环上下文

**使用方式**：
1. 点击工具栏的"数据抽屉"按钮
2. 选择要查看的执行步骤
3. 浏览变量值和节点输出

---

### 10.2 节点输出预览（Node Output Preview）

在配置面板中，可以预览节点的输出数据。

**功能**：
- 查看节点的输出结构
- 复制输出路径
- 验证变量路径是否正确

**使用方式**：
1. 选择节点
2. 在配置面板底部查看"节点输出预览"
3. 点击变量路径可复制

---

### 10.3 模拟运行日志

通过模拟运行日志可以查看详细的执行过程。

**功能**：
- 查看每个节点的执行状态
- 查看输入输出数据
- 查看错误信息
- 查看循环迭代详情

**使用方式**：
1. 点击"模拟运行"按钮
2. 在数据抽屉中查看日志
3. 点击日志条目查看详细信息

---

## 11. 总结

变量是工作流系统中实现节点间数据交互的核心机制，合理使用变量可以提高流程的灵活性和可维护性。

**关键要点**：

1. **变量类型**：全局参数、上游节点输出、系统变量、循环变量
2. **使用语法**：双大括号格式 `{{variable.path}}`
3. **选择器组件**：VariableSelector、VariableInput、VariableTextArea
4. **作用域**：upstream、internal、all
5. **替换机制**：自动替换占位符，支持深层路径访问
6. **最佳实践**：清晰命名、类型检查、错误处理、性能优化
7. **调试工具**：数据抽屉、节点输出预览、模拟运行日志

通过掌握变量使用规则和最佳实践，可以更好地设计和实现复杂的工作流逻辑。
