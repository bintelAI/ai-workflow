# 工作流变量使用文档

## 1. 变量概述

工作流系统中的变量用于在不同节点之间传递数据，实现节点间的数据共享和交互。变量可以来自全局参数、上游节点输出或系统内置变量。

## 2. 变量类型

### 2.1 全局参数

全局参数来自开始节点（Start Node）的输入数据，通过JSON格式配置，可在整个流程中使用。

**示例**：
```json
{
  "order_id": "ORD-2024-001",
  "amount": 8500,
  "currency": "CNY",
  "requester": {
    "id": "U-8821",
    "name": "Alex Chen",
    "department": "Engineering"
  }
}
```

**访问方式**：
- `payload.order_id`
- `payload.amount`
- `payload.requester.name`

### 2.2 上游节点输出

每个节点执行后会产生输出数据，下游节点可以访问这些数据。

**访问方式**：
- `nodes.<node_id>.output_field`

**示例**：
- `nodes.api_call_123.response` - API调用节点的响应数据
- `nodes.data_op_456.result` - 数据操作节点的处理结果
- `nodes.script_789.output` - 脚本节点的输出

### 2.3 系统变量

系统内置的变量，提供流程执行过程中的上下文信息。

| 变量名 | 描述 | 类型 |
|--------|------|------|
| `system.timestamp` | 当前时间戳 | date |
| `system.workflow_id` | 流程ID | string |

### 2.4 循环内部变量

在循环节点内部，可以访问循环相关的变量。

| 变量名 | 描述 | 类型 |
|--------|------|------|
| `loop.item` | 当前循环项 | any |
| `loop.index` | 当前循环索引 | number |

## 3. 变量使用语法

### 3.1 变量占位符格式

系统支持两种变量占位符格式：

1. 双大括号格式：`{{ variable.path }}`
2. 美元双大括号格式：`${{ variable.path }}`

**示例**：
```
# 在字符串中使用变量
"订单ID：{{ payload.order_id }}"
"金额：${{ payload.amount }} {{ payload.currency }}"

# 在对象中使用变量
{
  "url": "https://api.example.com/orders/{{ payload.order_id }}",
  "method": "GET"
}
```

### 3.2 变量选择器组件

在配置面板中，可以使用变量选择器组件方便地选择和插入变量：

1. 点击变量输入框
2. 从下拉列表中选择所需变量类型（全局参数、上游节点输出、系统变量等）
3. 选择具体变量，系统会自动插入变量占位符

## 4. 不同节点类型的变量使用

### 4.1 API调用节点

**请求URL**：
```
https://api.example.com/orders/{{ payload.order_id }}
```

**请求体**：
```json
{
  "amount": {{ payload.amount }},
  "currency": "{{ payload.currency }}",
  "requester": "{{ payload.requester.name }}"
}
```

### 4.2 条件节点

**条件表达式**：
```
{{ payload.amount }} > 10000
```

### 4.3 通知节点

**通知内容**：
```
尊敬的{{ payload.requester.name }}，您的订单{{ payload.order_id }}已处理完成，金额为{{ payload.amount }} {{ payload.currency }}。
```

### 4.4 脚本节点

**脚本代码**：
```javascript
// 访问全局变量
const orderId = context.payload.order_id;
const amount = context.payload.amount;

// 访问上游节点输出
const apiResponse = context.nodes.api_call_123.response;

// 处理数据
const result = {
  orderId: orderId,
  amount: amount,
  status: apiResponse.status === 200 ? 'success' : 'failed'
};

// 返回结果
return result;
```

## 5. 变量替换机制

系统在节点执行前会自动替换配置中的变量占位符，替换过程如下：

1. 收集当前上下文所有可用变量（全局参数、上游节点输出、系统变量）
2. 递归遍历节点配置对象
3. 替换所有字符串值中的变量占位符
4. 替换后的值用于节点执行

## 6. 最佳实践

1. **清晰命名**：为节点和变量使用清晰、描述性的名称，便于理解和维护
2. **避免深层嵌套**：尽量减少变量路径的嵌套层级，提高可读性
3. **类型检查**：在使用变量前，确保了解其类型，避免类型错误
4. **测试变量**：在流程模拟运行时，检查变量替换结果是否符合预期
5. **文档化变量**：对于复杂流程，文档化主要变量的来源和用途

## 7. 变量使用示例

### 7.1 简单流程示例

1. **开始节点**：配置全局参数 `{ "order_id": "ORD-2024-001", "amount": 8500 }`
2. **API调用节点**：使用 `{{ payload.order_id }}` 作为URL参数
3. **条件节点**：使用 `{{ payload.amount }} > 10000` 作为条件
4. **通知节点**：在通知内容中使用多个变量

### 7.2 复杂流程示例

1. **开始节点**：配置全局参数
2. **数据操作节点**：处理数据，输出 `result`
3. **API调用节点**：使用数据操作节点的输出 `{{ nodes.data_op_123.result }}` 作为请求体
4. **条件节点**：根据API响应 `{{ nodes.api_call_456.status }}` 进行判断
5. **循环节点**：遍历API响应中的数组 `{{ nodes.api_call_456.response.items }}`
6. **内部节点**：在循环内部使用 `{{ loop.item }}` 访问当前项

## 8. 故障排除

### 8.1 变量替换失败

- 检查变量路径是否正确
- 确保上游节点已正确执行并产生输出
- 检查变量类型是否匹配预期

### 8.2 变量值为空

- 检查全局参数是否正确配置
- 检查上游节点是否返回了预期的输出
- 确保变量路径没有拼写错误

## 9. 变量管理工具

### 9.1 变量选择器

在配置面板中，使用变量选择器组件可以方便地选择和插入变量，避免手动输入错误。

### 9.2 数据抽屉

通过数据抽屉可以查看流程执行过程中的变量值，帮助调试和验证变量使用是否正确。

## 10. 总结

变量是工作流系统中实现节点间数据交互的核心机制，合理使用变量可以提高流程的灵活性和可维护性。通过了解变量类型、使用语法和最佳实践，可以更好地设计和实现复杂的工作流逻辑。